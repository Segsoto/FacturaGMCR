{% extends "base.html" %}

{% block title %}Nueva Factura - Granimar CR{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-plus-circle me-2"></i>
            Nueva Factura de Servicio
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-invoice me-2"></i>
                    Información de la Factura
                </h5>
            </div>
            <div class="card-body">
                <form id="form-nueva-factura">
                    <!-- Información del Cliente -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-user me-2"></i>Información del Cliente
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label for="cliente_id" class="form-label">Cliente Registrado</label>
                            <select class="form-select" id="cliente_id" name="cliente_id">
                                <option value="">Seleccionar cliente existente (opcional)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="nombre_cliente" class="form-label">Nombre Completo *</label>
                            <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="email_cliente" class="form-label">Email del Cliente *</label>
                            <input type="email" class="form-control" id="email_cliente" name="email_cliente" required>
                            <div class="form-text">La factura se enviará a este email</div>
                        </div>
                    </div>

                    <!-- Información del Servicio -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-tools me-2"></i>Detalles del Servicio
                            </h6>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="descripcion_servicio" class="form-label">Descripción del Servicio</label>
                            <textarea class="form-control" id="descripcion_servicio" name="descripcion_servicio" rows="3" 
                                placeholder="Ej: Instalación de pisos, pintura, etc."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="producto_id" class="form-label">Producto/Servicio *</label>
                            <select class="form-select" id="producto_id" name="producto_id" required>
                                <option value="">Seleccionar producto...</option>
                            </select>
                            <div class="form-text">Selecciona el producto o servicio a facturar</div>
                        </div>
                        <div class="col-md-6">
                            <label for="metros_cuadrados" class="form-label">Metros Cuadrados *</label>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0.01" class="form-control" 
                                       id="metros_cuadrados" name="metros_cuadrados" required>
                                <span class="input-group-text">m²</span>
                            </div>
                        </div>
                        
                        <!-- Información del producto seleccionado -->
                        <div class="col-12 mt-3" id="producto-info" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Información del Producto</h6>
                                <div id="producto-detalles"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Imagen del Modelo -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-image me-2"></i>Imagen del Modelo
                            </h6>
                            <div class="upload-area" id="upload-area">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Arrastra una imagen aquí o haz clic para seleccionar</p>
                                    <input type="file" id="imagen_modelo" name="imagen_modelo" 
                                           accept="image/*" class="d-none">
                                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imagen_modelo').click()">
                                        <i class="fas fa-folder-open me-2"></i>Seleccionar Imagen
                                    </button>
                                </div>
                                <div id="preview-container" class="preview-container d-none">
                                    <img id="preview-image" src="" alt="Preview" class="preview-image">
                                    <button type="button" class="btn btn-sm btn-danger" id="remove-image">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="3" 
                                placeholder="Notas adicionales sobre el servicio..."></textarea>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-lg me-2">
                                <i class="fas fa-save me-2"></i>Crear Factura
                            </button>
                            <a href="/facturas" class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i>Cancelar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Panel de Cálculos -->
    <div class="col-md-4">
        <div class="card shadow sticky-top">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calculator me-2"></i>
                    Cálculo de Totales
                </h5>
            </div>
            <div class="card-body">
                <div class="calculation-item">
                    <div class="d-flex justify-content-between">
                        <span>Metros cuadrados:</span>
                        <span id="calc-metros">0 m²</span>
                    </div>
                </div>
                <div class="calculation-item">
                    <div class="d-flex justify-content-between">
                        <span>Precio por m²:</span>
                        <span id="calc-precio-metro">₡0.00</span>
                    </div>
                </div>
                <hr>
                <div class="calculation-item">
                    <div class="d-flex justify-content-between">
                        <strong>Subtotal:</strong>
                        <strong id="calc-subtotal">₡0.00</strong>
                    </div>
                </div>
                <div class="calculation-item">
                    <div class="d-flex justify-content-between">
                        <span>Impuestos (13%):</span>
                        <span id="calc-impuestos">₡0.00</span>
                    </div>
                </div>
                <hr>
                <div class="calculation-item">
                    <div class="d-flex justify-content-between">
                        <strong class="text-primary h5">Total:</strong>
                        <strong class="text-primary h5" id="calc-total">₡0.00</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información -->
        <div class="card shadow mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Información
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        La factura se enviará automáticamente al email del cliente
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        También se enviará una copia al email de la empresa
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Los impuestos se calculan automáticamente (13%)
                    </li>
                    <li>
                        <i class="fas fa-check text-success me-2"></i>
                        Formatos de imagen: JPG, PNG, GIF, WEBP (Max 5MB)
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.upload-area {
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.upload-area.dragover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.preview-container {
    position: relative;
    display: inline-block;
}

.preview-image {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.preview-container button {
    position: absolute;
    top: -10px;
    right: -10px;
    border-radius: 50%;
}

.calculation-item {
    margin-bottom: 10px;
}

.sticky-top {
    top: 20px !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/nueva-factura.js"></script>
{% endblock %}
